# https://dev.azure.com/home-assistant

trigger:
  - master
schedules:
- cron: "0 18 * * Mon"
  displayName: Weekly build
  branches:
    include:
    - master
  always: true
variables:
  - name: versionHadolint
    value: 'v1.16.3'
  - group: docker

stages:

- stage: 'Validate'
  jobs:
  - job: 'Hadolint'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: sudo docker pull hadolint/hadolint:$(versionHadolint)
      displayName: 'Install Hadolint'
    - script: |
        sudo docker run --rm -i \
          -v $(pwd)/.hadolint.yaml:/.hadolint.yaml:ro \
          hadolint/hadolint:$(versionHadolint) < Dockerfile
      displayName: 'Run Hadolint'

- stage: 'Deploy'
  jobs:
  - job: 'CI_Azure'
    condition: eq(variables['Build.SourceBranchName'], 'master')
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      matrix:
        Python36:
          tagVersion: '3.6'
          pythonVersion: '3.6.1'
        Python37:
          tagVersion: '3.7'
          pythonVersion: '3.7'
    steps:
    - script: sudo docker login -u $(dockerUser) -p $(dockerPassword)
      displayName: 'Docker hub login'
    - script: |
        set -e

        sudo docker build \
          --build-arg PYTHON_VERSION=$(pythonVersion) \
          --tag homeassistant/ci-azure:$(tagVersion) .

        sudo docker push homeassistant/ci-azure:$(tagVersion)
